# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Deploy (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch, tag, or SHA) to deploy to production (used for manual redeploy/rollback)."
        required: false
        default: ""
permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  deploy:
    # NOTE: We don't gate the entire job on secrets because the GitHub Actions
    # expression linter in editors can flag `secrets.*` as an invalid context
    # in some `if:` locations. Instead, we always run tests/builds and we
    # conditionally run the deploy steps based on env values.
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      RENDER_DEPLOY_HOOK_URL_PRODUCTION: ${{ secrets.RENDER_DEPLOY_HOOK_URL_PRODUCTION }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      PRODUCTION_BACKEND_URL: ${{ secrets.PRODUCTION_BACKEND_URL }}
      DEPLOYMENT_WEBHOOK_URL: ${{ secrets.DEPLOYMENT_WEBHOOK_URL }}

    steps:
      - name: Record start time
        run: echo "DEPLOY_START_EPOCH=$(date +%s)" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            server/package-lock.json
            tests/package-lock.json

      # --- Gate deployments on tests/builds ---
      - name: Install tests workspace deps
        working-directory: tests
        run: npm ci

      - name: Run test suite (server + frontend)
        working-directory: tests
        run: npm run test:all

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Frontend build
        working-directory: frontend
        run: npm run build

      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Server build
        working-directory: server
        run: npm run build

      # --- Create GitHub deployment record (history) ---
      - name: Create GitHub deployment
        id: gh_deploy
        uses: actions/github-script@v7
        with:
          script: |
            const res = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Production deployment via GitHub Actions'
            });
            core.setOutput('deployment_id', String(res.data.id));

      - name: Mark deployment in_progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.gh_deploy.outputs.deployment_id }}'),
              state: 'in_progress'
            });

      # --- Deploy backend (Render) ---
      - name: Trigger Render production deploy (deploy hook)
        if: env.RENDER_DEPLOY_HOOK_URL_PRODUCTION != ''
        run: |
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL_PRODUCTION"

      # --- Deploy frontend (Vercel production) ---
      - name: Deploy frontend to Vercel (production)
        if: env.VERCEL_TOKEN != '' && env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != ''
        working-directory: frontend
        run: |
          npx vercel@latest pull --yes --environment=production --token "$VERCEL_TOKEN"
          npx vercel@latest build --prod --token "$VERCEL_TOKEN"
          DEPLOY_URL=$(npx vercel@latest deploy --prebuilt --prod --token "$VERCEL_TOKEN")
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
          echo "Production frontend deploy: $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY

      - name: Record end time + write metrics
        if: always()
        run: |
          END=$(date +%s)
          echo "DEPLOY_END_EPOCH=$END" >> $GITHUB_ENV
          DURATION=$((END - ${DEPLOY_START_EPOCH}))
          echo "DEPLOY_DURATION_SECONDS=$DURATION" >> $GITHUB_ENV
          cat > deployment-metrics.json << EOF
          {
            "environment": "production",
            "ref": "${{ inputs.ref || github.sha }}",
            "sha": "${{ github.sha }}",
            "started_at_epoch": ${DEPLOY_START_EPOCH},
            "ended_at_epoch": ${END},
            "duration_seconds": ${DURATION},
            "frontend_url": "${DEPLOY_URL:-}",
            "backend_url": "${PRODUCTION_BACKEND_URL:-}"
          }
          EOF

      - name: Upload deployment metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-metrics-production
          path: deployment-metrics.json

      - name: Mark deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.gh_deploy.outputs.deployment_id }}'),
              state: 'success',
              environment_url: process.env.DEPLOY_URL || undefined,
              description: 'Production deployment succeeded'
            });

      - name: Mark deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number('${{ steps.gh_deploy.outputs.deployment_id }}'),
              state: 'failure',
              description: 'Production deployment failed'
            });

      - name: Notify team (optional webhook)
        if: always() && env.DEPLOYMENT_WEBHOOK_URL != ''
        env:
          WEBHOOK_URL: ${{ env.DEPLOYMENT_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
        run: |
          FRONTEND_URL="${DEPLOY_URL:-}"
          BACKEND_URL="${PRODUCTION_BACKEND_URL:-}"
          BODY=$(cat <<EOF
          {
            "text": "FlowATS production deploy: ${STATUS}. ref=${{ inputs.ref || github.sha }} sha=${{ github.sha }} frontend=${FRONTEND_URL} backend=${BACKEND_URL} duration=${DEPLOY_DURATION_SECONDS:-}s"
          }
          EOF
          )
          curl -fsS -X POST -H "Content-Type: application/json" -d "$BODY" "$WEBHOOK_URL"
